<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイル確認html</title>
    <link rel="stylesheet" href="https://skybrain.ekispert.jp/lib/leaflet-1.0.0-rc3/leaflet.css" />
    <link rel="stylesheet" href="tgl.css" />
    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <script src="https://skybrain.ekispert.jp/lib/leaflet-1.0.0-rc3/leaflet.js"></script>
    <script src="https://skybrain.ekispert.jp/lib/leaflet-hash/leaflet-hash.js"></script>
    <style>
      html, body { width: 100%; height: 100%; }
      #map { float: left; height: 100%; width: calc(100% - 454px);}
      #sidebar { float: left; height: 100%; width: 454px; }
      input#time { font-size: 32px; }
    </style>
    <script>
      var g_running = true;
      var g_map;
      //var marker;
      var g_bus_marker;
      var g_icon = L.divIcon({
        html: '<img src="https://skybrain.ekispert.jp/img/bus_icon?color=EE1D23&w=46&h=46">',
        className: '',
        iconSize: [46, 46],
        iconAnchor: [23, 30],
        popupAnchor: [23, 10],
      });

      // 初期化
      function init() {
        g_map = L.map('map', {
          maxZoom: 15,
          minZoom: 10,
          zoom: 13,
          center: [-0.05126953125, 0.044921875],
          crs: L.CRS.Simple,
          continuousWorld: true,
        });

        var southWest = [-0.0980224609375, 0.000244140625];
        var northEast = [0, 0.088134765625];

        var main_layer = L.tileLayer('./tile/{z}/{x}_{y}.png?2', {
          noWrap: true,  // trueの場合、左右リピートしない
          maxNativeZoom: 13,
          bounds: [southWest, northEast],
        }).addTo(g_map);

        var hash = new L.Hash(g_map);
        //marker = L.marker(g_map.getCenter()).addTo(g_map);
        //g_map.on('click', function(e) {
        //marker.setLatLng(e.latlng);
        //console.log(e.latlng.lat + ", " + e.latlng.lng);
        //});

        $('#sidebar').keydown(function(e) {
          if (e.keyCode == 37) {
            incrementTime(-10);
            updateBus();
          } else if (e.keyCode == 39) {
            incrementTime(10);
            updateBus();
          }
        });

        var setRunning = function() {
          g_running = $('#cb1').prop("checked");
        };

        $('#cb1').click(setRunning);

        setRunning();
        console.log("g_running", g_running);
        // タイマー開始
        setTimeout(update, 0);
      }

      // 時刻を進める、または戻す
      function incrementTime(delta) {
        var time = $('#time').val();
        var a = time.split(":");
        var seconds = parseInt(a[0]) * 60*60 + parseInt(a[1]) * 60 + parseInt(a[2]);
        seconds += delta;
        $('#time').val(Math.floor(seconds / 3600) + ":" + zeroPad(Math.floor((seconds % 3600) / 60), 2)+ ":" + zeroPad(seconds % 60, 2));
      }

      // バスの表示位置を更新
      function updateBus() {
        var time = "2017-02-14 " + $('#time').val();
        $.getJSON("/bus_coords", {route_ids: "J22209L011:J22209L012", time: time}, function(result) {
          console.log(result);
          if (result.coords) {
            if (g_bus_marker) {
              g_bus_marker._icon.style[L.DomUtil.TRANSITION] = ('all ' + 250 + 'ms linear');
              g_bus_marker.setLatLng(result.coords);
            } else {
              g_bus_marker = L.marker(result.coords, {icon: g_icon}).addTo(g_map);
            }
          }
        });
      }

      // 一定時間ごとに呼ばれる
      function update() {
        if (g_running) {
          incrementTime(10);
          updateBus();
        }
        setTimeout(update, 250);
      }
     
      // ゼロ埋め
      function zeroPad(num, len) {
        var str = String(num);
        return ("0000000000" + str).substr(10 + str.length - len);
      }

      $(function() {
        init();
      });

    </script>
  </head>
  <body>
    <div id="map"></div>
    <div id="sidebar">
        時刻: <input type="text" id="time" name="time" value="12:40:00">

        <input type="checkbox" id="cb1" class="tgl tgl-ios" checked>
        <label class="tgl-btn" for="cb1"></label>

        <br>

        TODO:<br>
        ・複数バス同時表示への対応。bus_code == trip_idにすればいいはず
        ・skylibs.jsと統合

        <br><br>

        <br>
        <a href="https://www.city.shimada.shizuoka.jp/bouhan/documents/busmap.pdf" target="_blank">島田市バスマップ（PDF）</a>
        <br>

        <img src="sasamado.png">
    </div>
  </body>
</html>
<!-- vim: set ts=2 sts=2 sw=2 expandtab list: -->
